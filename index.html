<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LEK SANDOZ - WAREHOUSE TRACKER (Cloud)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.3.0/firebase-app.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.3.0/firebase-database.min.js"></script>
<style>
/* Clean, Modern Dark Theme */
:root{
  --bg:#0d1117;--card:#161b22;--panel:#21262d;--muted:#30363d;
  --accent-blue:#58a6ff;--accent-yellow:#facc15;--ok:#34d399;--warn:#f87171;
  --text:#c9d1d9;--shadow-color:rgba(0,0,0,0.4);
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Montserrat',sans-serif;}
.app-container{max-width:1200px;margin:0 auto;padding:20px;}
h1{text-align:center;margin:0 0 24px 0;font-weight:600;font-size:1.8em;display:flex;justify-content:space-between;align-items:center;}
h1 span:first-child{flex-grow:1;text-align:center;}

.adjust-section{background:var(--card);padding:16px;border-radius:10px;margin-bottom:18px;box-shadow:0 4px 12px var(--shadow-color);}
.adjust-section h2{margin:0 0 12px 0;display:flex;align-items:center;justify-content:space-between;font-size:0.9em;text-transform:uppercase;font-weight:600;color:var(--text)}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

input,select,button{
  background:var(--muted);border:1px solid var(--muted);padding:10px 14px;border-radius:6px;
  color:var(--text);font-size:0.95em;font-family:'Montserrat',sans-serif;
  transition:all .2s cubic-bezier(.2,0,0,1);
}
input:focus{border-color:var(--accent-blue);box-shadow:0 0 0 2px rgba(88,166,255,.3);background:var(--panel);}
button{cursor:pointer;font-weight:600;text-transform:uppercase;font-size:.85em;letter-spacing:.5px;box-shadow:0 2px 4px rgba(0,0,0,.3);}
button:hover{opacity:1;transform:translateY(-2px);box-shadow:0 4px 15px var(--shadow-color);}
button:active{transform:translateY(0) scale(.98);box-shadow:0 1px 4px rgba(0,0,0,.5);}

.btn-add{background:var(--ok);color:var(--bg);border-color:var(--ok)}
.btn-take{background:var(--warn);color:var(--bg);border-color:var(--warn)}
.btn-remove{background:#ff9800;color:var(--bg);border-color:#ff9800}
.btn-new,.add-list-btn{background:var(--accent-blue);color:var(--bg);border-color:var(--accent-blue)}
.btn-clear{background:#777;color:#fff;padding:8px 10px;border-radius:6px;font-size:.78em;box-shadow:none;}

.layout{display:flex;gap:20px;align-items:flex-start}
.main-table-container{
  flex:4;
  min-width:360px;
  max-height:800px;
  overflow:auto;
  background:var(--panel);
  padding:0;
  border-radius:10px;
  box-shadow:0 4px 12px var(--shadow-color);
}
.side-tables-container{flex:1;min-width:180px;display:flex;flex-direction:column;gap:10px}

/* Side Card */
.card{background:var(--card);color:var(--text);padding:12px 14px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .15s ease-out;border-left:4px solid var(--card);}
.card:hover{background:var(--panel);}
.card.selected{background:var(--accent-blue);color:#000;border-left:4px solid #000;}
.card.lowstock{border-left:4px solid var(--warn);}
.card .card-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:8px;font-weight:500;color:inherit;}
.card .del{background:transparent;border:0;color:var(--text);opacity:.6;padding:0;font-size:1em;transition:opacity .1s}
.card.selected .del{color:#000;}
.card .del:hover{opacity:1;transform:none}

/* Table */
table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;color:var(--text);font-family:'Montserrat',sans-serif;}
th,td{padding:12px 8px;text-align:center;border-bottom:1px solid var(--muted);word-wrap:break-word}
th{background:var(--accent-blue);color:#000;text-transform:uppercase;position:sticky;top:0;z-index:2;font-weight:600;border-bottom:none;}
.main-table-container table{overflow:hidden;}
.main-table-container table thead{border-radius:10px 10px 0 0;}
.main-table-container table thead tr th:first-child{border-top-left-radius:10px;}
.main-table-container table thead tr th:last-child{border-top-right-radius:10px;}

tbody tr.lowstock{background:rgba(248,113,113,.1)!important;color:var(--warn)}
tbody tr:nth-child(even):not(.lowstock){background:var(--panel)}
tbody tr:nth-child(odd):not(.lowstock){background:var(--card)}
tbody tr:last-child td{border-bottom:none;}

.lowstock-summary{margin:20px 0;padding:15px;border-radius:10px;background:var(--card);border-left:4px solid var(--warn);}
.lowstock-summary strong{display:block;text-transform:uppercase;font-size:.85em;margin-bottom:8px;color:var(--warn);}
.lowstock-summary ul{margin:0;padding-left:20px;color:var(--warn);list-style:disc;}

#log{margin-top:16px;background:var(--panel);padding:12px;border-radius:10px;max-height:260px;overflow:auto;border:1px solid var(--muted)}
.log-row{font-size:.85em;padding:8px 0;border-bottom:1px solid #2b2b2b}
.log-row.added{color:var(--ok)}
.log-row.took{color:var(--warn)}

.main closed-category-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:12px 16px 0 16px;}
.main-category-header h2{margin:0;font-size:1.05em;font-weight:600;text-transform:none}
.rename-btn{background:none;border:0;color:var(--accent-blue);cursor:pointer;font-size:1.05em;padding:4px}
.small{font-size:.9em}

/* Inline Input */
.inline-input{width:100%;padding:6px 4px;background:transparent;border:1px solid var(--muted);text-align:center;font-size:.9em;height:30px;box-sizing:border-box;}
.inline-input:focus{background:var(--panel);border-color:var(--accent-blue);box-shadow:0 0 0 2px rgba(88,166,255,.3);}
.min-stock-input{width:60px;margin:0 auto;display:block;}

/* Column Widths */
table th.col-id,table td.col-id{width:15%;min-width:100px;}
table th.col-name,table td.col-name{width:40%;min-width:150px;text-align:left;padding-left:12px;}
table th.col-unit,table td.col-unit{width:15%;min-width:70px;}
table th.col-qty,table td.col-qty{width:15%;min-width:70px;}
table th.col-minstock,table td.col-minstock{width:15%;min-width:80px;}

/* Animations */
@keyframes fadeInSlideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
tbody tr{animation:fadeInSlideUp .3s ease-out backwards;animation-delay:var(--delay,0s);}

@media (max-width:900px){
  .layout{flex-direction:column}
  .side-tables-container{order:2;min-width:unset;}
  .app-container{padding:10px;}
  .main-table-container{max-height:600px;}
}

/* Modal */
.custom-modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:101;display:flex;justify-content:center;align-items:center;opacity:0;transition:opacity .2s ease-out;}
.custom-modal-content{background:var(--card);padding:20px;border-radius:10px;box-shadow:0 8px 25px rgba(0,0,0,.8);width:90%;max-width:400px;color:var(--text);transform:translateY(20px) scale(.95);transition:transform .2s cubic-bezier(.175,.885,.32,1.275);}
.custom-modal-active{opacity:1;}
.custom-modal-active .custom-modal-content{transform:translateY(0) scale(1);}
#modalTitle{font-size:1.2em;font-weight:600;margin:0 0 15px 0;}
#modalInput{width:100%;margin-bottom:15px;box-sizing:border-box;transition:all .2s ease-in-out;}
.modal-buttons{display:flex;justify-content:flex-end;gap:10px;}
.btn-cancel{background:var(--muted);color:var(--text);border-color:var(--muted);}
.btn-cancel:hover{background:#3a4149;}
</style>
</head>
<body>

<div class="app-container" id="main-content">
<h1><span>LEK SANDOZ - WAREHOUSE TRACKER (Cloud)</span></h1>

<div class="adjust-section">
  <h2>Adjust Inventory</h2>
  <div class="controls">
    <input id="itemId" placeholder="Item ID">
    <input id="quantity" type="number" placeholder="Qty">
    <button class="btn-add" onclick="adjustInventory('add')">Add</button>
    <button class="btn-take" onclick="adjustInventory('take')">Take</button>
    <button class="btn-remove" onclick="removeMaterial()">Remove</button>
  </div>
</div>

<div class="adjust-section">
  <h2>Add New Material</h2>
  <div class="controls">
    <select id="newCategorySelect"></select>
    <input id="newId" placeholder="New Item ID">
    <input id="newName" placeholder="Name">
    <input id="newUnit" placeholder="Unit">
    <input id="newAmount" type="number" placeholder="Qty">
    <input id="newMinStock" type="number" placeholder="Min Stock">
    <button class="btn-new" onclick="addMaterial()">Add Material</button>
  </div>
</div>

<div class="adjust-section">
  <h2>Search Material</h2>
  <div class="controls">
    <input id="searchInput" placeholder="Type partial name..." oninput="onSearchInput()">
  </div>
</div>

<div class="layout">
  <div class="main-table-container" id="mainTableContainer"></div>
  <div class="side-tables-container" id="sideTablesContainer">
    <button class="add-list-btn" onclick="addNewCategory()">+ Add New List</button>
  </div>
</div>

<div class="lowstock-summary" id="lowStockSummary"></div>

<div class="adjust-section">
  <h2 style="display:flex;align-items:center;justify-content:space-between;">
    <span>Change Log (Cloud Shared)</span>
    <button class="btn-clear" onclick="clearLogs()">Clear Logs</button>
  </h2>
  <div id="log"></div>
</div>
</div>

<!-- Modal -->
<div id="customModal" class="custom-modal-backdrop" style="display:none;">
  <div class="custom-modal-content">
    <h3 id="modalTitle"></h3>
    <p id="modalMessage"></p>
    <input type="text" id="modalInput" style="display:none;">
    <div class="modal-buttons">
      <button id="modalCancel" class="btn-cancel">Cancel</button>
      <button id="modalConfirm" class="btn-new">Confirm</button>
    </div>
  </div>
</div>

<script>
// ========== YOUR FIREBASE CONFIG (ALREADY INSERTED) ==========
const firebaseConfig = {
  apiKey: "AIzaSyAaQnyOw5ng9hdbhF4n1Pk3q2wOcRDyBOc",
  authDomain: "warehouse-tracker-773e4.firebaseapp.com",
  databaseURL: "https://warehouse-tracker-773e4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "warehouse-tracker-773e4",
  storageBucket: "warehouse-tracker-773e4.firebasestorage.app",
  messagingSenderId: "333352186691",
  appId: "1:333352186691:web:8353c13beab330b7ccf5f6",
  measurementId: "G-K83PPK5P5N"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ========== App Logic ==========
const LS_CATEGORY = "warehouseCurrentCategory_final_local";

let materials = {};
let categories = [];
let currentCategory = 'default';
let currentSearchTerm = "";
let logData = [];

// DOM
const mainContainer = document.getElementById("mainTableContainer");
const sideContainer = document.getElementById("sideTablesContainer");
const newSelect = document.getElementById("newCategorySelect");
const logDiv = document.getElementById("log");
const lowStockDiv = document.getElementById("lowStockSummary");
const searchInput = document.getElementById("searchInput");

// Modal
const customModal = document.getElementById('customModal');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalInput = document.getElementById('modalInput');
const modalCancel = document.getElementById('modalCancel');
const modalConfirm = document.getElementById('modalConfirm');

// ========== Firebase Sync ==========
function loadAll(){
  db.ref().on('value', (snapshot) => {
    const data = snapshot.val() || {};
    materials = data.materials || {'default':{key:'default',name:'Main Warehouse',items:[]}};
    logData = data.log || [];
    currentCategory = localStorage.getItem(LS_CATEGORY) || 'default';
    categories = Object.keys(materials);
    if(!categories.includes(currentCategory)) currentCategory = categories[0] || 'default';
    renderTables();
  });
}
function saveAll(){
  db.ref().update({
    materials,
    log: logData
  });
  localStorage.setItem(LS_CATEGORY, currentCategory);
}

// ========== Utils ==========
function pushLog(msg){
  logData.unshift({msg,timestamp:Date.now()});
  if(logData.length>50) logData.pop();
  saveAll();
}

function showCustomModal({title,message,input=false,inputValue='',confirmText='Confirm'}){
  return new Promise(resolve=>{
    modalTitle.textContent=title;
    modalMessage.textContent=message;
    modalInput.style.display=input?'block':'none';
    modalInput.value=inputValue;
    modalConfirm.textContent=confirmText;
    modalCancel.style.display=(confirmText!=='OK')?'inline-flex':'none';

    const cleanup=()=>{
      modalConfirm.removeEventListener('click',handleConfirm);
      modalCancel.removeEventListener('click',handleCancel);
      modalInput.onkeydown=null;
      customModal.classList.remove('custom-modal-active');
      setTimeout(()=>{customModal.style.display='none';},200);
    };
    const handleConfirm=()=>{ resolve(input?modalInput.value.trim():true); cleanup(); };
    const handleCancel=()=>{ resolve(false); cleanup(); };

    modalConfirm.addEventListener('click',handleConfirm);
    modalCancel.addEventListener('click',handleCancel);
    customModal.style.display='flex';
    setTimeout(()=>customModal.classList.add('custom-modal-active'),10);

    if(input){
      setTimeout(()=>modalInput.focus(),10);
      modalInput.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();handleConfirm();}};
    }else setTimeout(()=>modalConfirm.focus(),10);
  });
}
function showAlertModal(title,message){ return showCustomModal({title,message,input:false,confirmText:"OK"}); }

// ========== Min Stock Update ==========
function updateItemInline(id,fieldName,inputElement){
  if(fieldName!=='minStock') return;
  const listData=materials[currentCategory];
  const item=listData.items.find(i=>String(i.id)===String(id));
  if(!item) return;
  const oldValue=item.minStock;
  const numValue=parseInt(inputElement.value.trim());
  if(isNaN(numValue)||numValue<0){
    showAlertModal("Invalid Input","Minimum stock must be a non-negative number.");
    inputElement.value=oldValue;
    return;
  }
  if(item.minStock!==numValue){
    item.minStock=numValue;
    pushLog(`Updated min stock for ${item.name}: ${oldValue} to ${numValue}`);
    saveAll();
  }
}

// ========== Rendering ==========
function renderTables(){
  if(currentSearchTerm) renderSearchResults();
  else renderMainTable();
  renderSideCards(); updateSelects(); updateLowStockSummary(); renderLog();
}

function renderMainTable(){
  const list=materials[currentCategory]||{items:[]};
  const items=list.items;
  const listName=list.name||currentCategory;

  mainContainer.innerHTML="";
  const wrapper=document.createElement("div"); wrapper.style.padding="0 16px 16px 16px";

  const header=document.createElement("div"); header.className="main-category-header";
  header.innerHTML=`<h2>${listName}</h2><div style="margin-left:6px"><button class="rename-btn" onclick="renameCategory('${currentCategory}')">Edit</button></div>`;
  mainContainer.appendChild(header);

  const table=document.createElement("table");
  table.innerHTML=`
  <thead><tr>
    <th class="col-id">ID</th>
    <th class="col-name">Name</th>
    <th class="col-unit">Unit</th>
    <th class="col-qty">QTY</th>
    <th class="col-minstock">Min Stock</th>
  </tr></thead>
  <tbody>
    ${items.map((it,i)=>{
      const id=String(it.id).replace(/"/g,'&quot;');
      const name=(it.name||"").replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const unit=(it.unit||"").replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const lowClass=(it.amount<=it.minStock)?"lowstock":"";
      const onUpdate=`updateItemInline('${id}','minStock',this)`;
      const onEnter=`if(event.key==='Enter'){${onUpdate};this.blur();}`;
      return `<tr class="${lowClass}" style="--delay:${i*.03}s;">
        <td class="col-id" style="word-break:break-all">${id}</td>
        <td class="col-name">${name}</td>
        <td class="col-unit">${unit}</td>
        <td class="col-qty">${it.amount}</td>
        <td class="col-minstock"><input type="number" class="inline-input min-stock-input" value="${it.minStock}" min="0" onchange="${onUpdate}" onkeydown="${onEnter}"></td>
      </tr>`;
    }).join("")}
  </tbody>`;
  wrapper.appendChild(table); mainContainer.appendChild(wrapper);
}

function renderSearchResults(){
  mainContainer.innerHTML="";
  const wrapper=document.createElement("div"); wrapper.style.padding="0 16px 16px 16px";

  const header=document.createElement("div"); header.className="main-category-header";
  header.innerHTML=`<h2>Search: "${currentSearchTerm}"</h2>`;
  mainContainer.appendChild(header);

  let hasResults=false;
  categories.forEach(cat=>{
    const list=materials[cat];
    const matches=list.items.filter(it=>it.name.toLowerCase().includes(currentSearchTerm));
    if(matches.length===0) return;
    hasResults=true;

    const sub=document.createElement("div");
    sub.style.margin="20px 0 8px 0"; sub.style.fontWeight="600"; sub.style.color="var(--accent-blue)";
    sub.textContent=`to ${list.name}`;
    wrapper.appendChild(sub);

    const table=document.createElement("table");
    table.innerHTML=`
    <thead><tr>
      <th class="col-id">ID</th><th class="col-name">Name</th><th class="col-unit">Unit</th><th class="col-qty">QTY</th><th class="col-minstock">Min Stock</th>
    </tr></thead>
    <tbody>
      ${matches.map((it,i)=>{
        const id=String(it.id).replace(/"/g,'&quot;');
        const name=it.name.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const unit=(it.unit||"").replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const lowClass=(it.amount<=it.minStock)?"lowstock":"";
        const highlight=name.toLowerCase().includes(currentSearchTerm)?'style="background:rgba(88,166,255,.2)"':"";
        return `<tr class="${lowClass}" style="--delay:${i*.03}s;">
          <td class="col-id" style="word-break:break-all">${id}</td>
          <td class="col-name" ${highlight}>${name}</td>
          <td class="col-unit">${unit}</td>
          <td class="col-qty">${it.amount}</td>
          <td class="col-minstock"><input type="number" class="inline-input min-stock-input" value="${it.minStock}" disabled></td>
        </tr>`;
      }).join("")}
    </tbody>`;
    wrapper.appendChild(table);
  });

  if(!hasResults){
    const msg=document.createElement("div");
    msg.style.padding="30px"; msg.style.textAlign="center"; msg.style.opacity=".7";
    msg.textContent=`No items found for "${currentSearchTerm}"`;
    wrapper.appendChild(msg);
  }
  mainContainer.appendChild(wrapper);
}

function renderSideCards(){
  const children=Array.from(sideContainer.children);
  const start=children[0]?.classList.contains('add-list-btn')?1:0;
  for(let i=sideContainer.children.length-1;i>=start;i--) sideContainer.removeChild(sideContainer.children[i]);

  categories.forEach(cat=>{
    const card=document.createElement('div');
    card.className='card'+(cat===currentCategory?' selected':'');
    const list=materials[cat]||{items:[],name:cat};
    const span=document.createElement('div'); span.className='card-name'; span.textContent=list.name;
    card.appendChild(span);
    const del=document.createElement('button'); del.className='del small'; del.textContent='Delete'; del.title='Delete list';
    del.onclick=e=>{e.stopPropagation();deleteCategory(cat);};
    card.appendChild(del);
    card.onclick=()=>{if(currentCategory!==cat){currentCategory=cat;saveAll();renderTables();}};
    if(list.items.some(i=>i.amount<=i.minStock)) card.classList.add('lowstock');
    sideContainer.appendChild(card);
  });
}

function updateSelects(){
  newSelect.innerHTML="";
  categories.forEach(cat=>{
    const opt=document.createElement("option");
    opt.value=cat; opt.textContent=materials[cat].name;
    newSelect.appendChild(opt);
  });
  newSelect.value=currentCategory;
}

function updateLowStockSummary(){
  const low=[];
  categories.forEach(cat=>{
    const list=materials[cat]||{items:[]};
    list.items.forEach(i=>{
      if(i.amount<=i.minStock){
        low.push(`${i.name} – ${i.unit} – ${i.amount}`);
      }
    });
  });
  lowStockDiv.innerHTML=low.length
    ? `<strong>Low stock items:</strong><ul>${low.map(x=>`<li>${x}</li>`).join('')}</ul>`
    : `<strong>Low stock items:</strong><div class="small" style="color:var(--text);opacity:.7;">All items above minimum stock</div>`;
}

function renderLog(){
  logDiv.innerHTML="";
  logData.forEach(entry=>{
    const row=document.createElement('div'); row.className='log-row';
    if(entry.msg.startsWith("Added")) row.classList.add('added');
    if(entry.msg.startsWith("Took")) row.classList.add('took');
    row.textContent=`[${new Date(entry.timestamp).toLocaleTimeString()}] ${entry.msg}`;
    logDiv.appendChild(row);
  });
}

// ========== CRUD ==========
async function addNewCategory(){
  const name=await showCustomModal({title:"New List",message:"Enter list name:",input:true,confirmText:"Create"});
  if(!name) return;
  const key=name.toLowerCase().trim().replace(/[^a-z0-9]+/g,"_").substring(0,50);
  if(!key||categories.includes(key)) return showAlertModal("Error","Invalid or duplicate name.");
  materials[key]={name,key,items:[]}; categories.push(key); currentCategory=key;
  pushLog(`Created list: ${name}`); saveAll();
}
async function deleteCategory(cat){
  const name=materials[cat]?.name||cat;
  const ok=await showCustomModal({title:`Delete ${name}?`,message:`This will delete ALL items in "${name}".`,confirmText:"Delete"});
  if(!ok) return;
  delete materials[cat]; categories=Object.keys(materials);
  if(categories.length===0){
    materials={'default':{key:'default',name:'Main Warehouse',items:[]}};
    categories=['default']; currentCategory='default';
    pushLog("Auto-created Main Warehouse");
  }else currentCategory=categories.includes(currentCategory)?currentCategory:categories[0];
  pushLog(`Deleted list: ${name}`); saveAll();
}
function renameCategory(cat){
  const cur=materials[cat]?.name||cat;
  showCustomModal({title:"Rename List",message:`New name for "${cur}":`,input:true,inputValue:cur,confirmText:"Rename"})
    .then(newName=>{if(newName&&newName!==cur){materials[cat].name=newName;pushLog(`Renamed ${cur} to ${newName}`);saveAll();}});
}
function addMaterial(){
  const cat=newSelect.value||currentCategory;
  const id=document.getElementById("newId").value.trim();
  const name=document.getElementById("newName").value.trim();
  const unit=document.getElementById("newUnit").value.trim();
  const amount=parseFloat(document.getElementById("newAmount").value);
  const minStock=parseFloat(document.getElementById("newMinStock").value);
  if(!id||!name||!unit||isNaN(amount)||isNaN(minStock)||amount<0||minStock<0)
    return showAlertModal("Error","Fill all fields with valid non-negative numbers.");
  const list=materials[cat]||{items:[]};
  if(list.items.some(i=>String(i.id)===id))
    return showAlertModal("Error","Item ID already exists in this list.");
  list.items.push({id,name,unit,amount,minStock});
  pushLog(`Added ${name} to ${list.name}`);
  ["newId","newName","newUnit","newAmount","newMinStock"].forEach(id=>document.getElementById(id).value="");
  saveAll();
}
async function adjustInventory(action){
  const id=document.getElementById("itemId").value.trim();
  const qty=parseFloat(document.getElementById("quantity").value);
  if(!id||isNaN(qty)||qty<=0) return showAlertModal("Error","Enter valid ID and positive quantity.");
  const list=materials[currentCategory]||{items:[]};
  const item=list.items.find(i=>String(i.id)===id);
  if(!item) return showAlertModal("Error","Item not found in current list.");
  let change=action==='add'?qty:-qty;
  if(action==='take'&&item.amount<qty){
    const ok=await showCustomModal({title:"Low Stock",message:`Only ${item.amount} available. Take ${qty} anyway?`,confirmText:"Take"});
    if(!ok) return;
  }
  item.amount+=change;
  pushLog(`${action==='add'?'Added':'Took'} ${qty} of ${item.name}`);
  document.getElementById("itemId").value="";
  document.getElementById("quantity").value="";
  saveAll();
}
async function removeMaterial(){
  const id=document.getElementById("itemId").value.trim();
  if(!id) return showAlertModal("Error","Enter item ID.");
  const list=materials[currentCategory]||{items:[]};
  const idx=list.items.findIndex(i=>String(i.id)===id);
  if(idx===-1) return showAlertModal("Error","Item not found.");
  const item=list.items[idx];
  const ok=await showCustomModal({title:`Remove ${item.name}?`,message:"This is permanent.",confirmText:"Remove"});
  if(!ok) return;
  list.items.splice(idx,1);
  pushLog(`Removed ${item.name}`);
  document.getElementById("itemId").value="";
  saveAll();
}

function onSearchInput(){
  currentSearchTerm=searchInput.value.trim().toLowerCase();
  renderTables();
}

async function clearLogs(){
  const ok=await showCustomModal({title:"Clear Logs?",message:"This cannot be undone.",confirmText:"Clear"});
  if(ok){ logData=[]; saveAll(); }
}

// ========== Init ==========
window.onload=()=>{ loadAll(); };
</script>
</body>
</html>